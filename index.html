<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solana Rug Checker (Name Demo)</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .title {
      font-size: 2rem;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    .input-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .input-row input {
      flex: 1;
      padding: 0.5rem;
      background: #222;
      border: 1px solid #444;
      color: #fff;
      border-radius: 4px;
    }
    .input-row button {
      background: #27ae60;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
    }
    .analysis-section {
      background: #1f1f1f;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 2rem;
    }
    .analysis-section h2 {
      margin-top: 0;
      margin-bottom: 1rem;
    }
    .card {
      background: #2b2b2b;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid #333;
    }
    .card h3 {
      margin: 0 0 0.5rem 0;
    }
    .risk-label {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: bold;
    }
    .risk-low {
      background-color: #27ae60;
    }
    .risk-medium {
      background-color: #f39c12;
    }
    .risk-high {
      background-color: #c0392b;
    }
  </style>

  <!-- Include the Solana web3.js library (for PublicKey, findProgramAddress, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.76.0/dist/web3.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="title">Solana Rug Checker</div>
    <div class="input-row">
      <input id="tokenAddress" placeholder="token address here" />
      <button id="checkBtn">Rug Check</button>
    </div>

    <div id="analysis" class="analysis-section" style="display: none;">
      <h2>Token Safety Analysis</h2>
      <div id="analysis-content"></div>
    </div>
  </div>

  <script>
    // WARNING: Exposes your API key publicly! For DEMO only, not production.
    const HELIUS_URL =
      "https://mainnet.helius-rpc.com/?api-key=f7f694d9-993a-46ba-adbf-3e1ec4f29416";

    // The Metaplex metadata program ID
    const METADATA_PROGRAM_ID = new solanaWeb3.PublicKey(
      "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"
    );

    // Derive the PDA for the Metaplex metadata account for a given mint
    async function getMetadataPDA(mintPubkey) {
      // findProgramAddress is asynchronous
      const [pda] = await solanaWeb3.PublicKey.findProgramAddress(
        [
          Buffer.from("metadata"),
          METADATA_PROGRAM_ID.toBuffer(),
          mintPubkey.toBuffer()
        ],
        METADATA_PROGRAM_ID
      );
      return pda;
    }

    // Attempt to fetch the on-chain metadata account and parse out the "name"
    async function fetchTokenName(tokenAddress) {
      try {
        const mintPubkey = new solanaWeb3.PublicKey(tokenAddress);
        const metadataPDA = await getMetadataPDA(mintPubkey);

        // Now we do a getAccountInfo on the metadata PDA
        const payload = {
          jsonrpc: "2.0",
          id: 1,
          method: "getAccountInfo",
          params: [
            metadataPDA.toBase58(),
            { encoding: "base64" }
          ]
        };

        const resp = await fetch(HELIUS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        const base64Data = json?.result?.value?.data?.[0];
        if (!base64Data) {
          // No metadata found
          return null;
        }

        // Decode base64
        const buffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));

        // The Metaplex metadata layout is quite complex. We'll do a partial parse:
        // Typically, name is at offset ~ 1 + 32 + 32 + 4... But it can vary.
        // A robust parse would use a library. We'll do a quick approach.

        // There's a 1-byte key, then 32 for updateAuth, 32 for mint,
        // then a variable length "name" (string) preceded by a u16 length.

        // We'll skip 1 + 32 + 32 = 65 bytes. Then read 4 bytes for name length, then read the name.
        let offset = 65;
        const nameLength = (buffer[offset]) +
                           (buffer[offset+1] << 8) +
                           (buffer[offset+2] << 16) +
                           (buffer[offset+3] << 24);
        offset += 4;
        const nameBytes = buffer.slice(offset, offset + nameLength);
        const name = new TextDecoder().decode(nameBytes).replace(/\0/g, "");

        return name || null;
      } catch (e) {
        console.warn("Error fetching token name:", e);
        return null;
      }
    }

    document.getElementById("checkBtn").addEventListener("click", async () => {
      const tokenAddress = document.getElementById("tokenAddress").value.trim();
      if (!tokenAddress) {
        alert("Please enter a token address");
        return;
      }

      // We'll do two calls:
      // 1) getTokenSupply -> to get total supply
      // 2) getAccountInfo -> for freezeAuthority, mintAuthority
      // Then we fetch the Metaplex metadata name (if it exists).
      const supplyPayload = {
        jsonrpc: "2.0",
        id: 1,
        method: "getTokenSupply",
        params: [tokenAddress],
      };
      const accountInfoPayload = {
        jsonrpc: "2.0",
        id: 1,
        method: "getAccountInfo",
        params: [
          tokenAddress,
          { encoding: "jsonParsed" },
        ],
      };

      let supplyData, accountInfoData, tokenName;
      try {
        // 1) Fetch token supply
        const supplyRes = await fetch(HELIUS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(supplyPayload),
        });
        const supplyJson = await supplyRes.json();
        supplyData = supplyJson?.result?.value;

        // 2) Fetch account info (for authorities)
        const accountRes = await fetch(HELIUS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(accountInfoPayload),
        });
        const accountJson = await accountRes.json();
        accountInfoData = accountJson?.result?.value?.data?.parsed?.info;

        // 3) Try to fetch the token name from Metaplex metadata
        tokenName = await fetchTokenName(tokenAddress);
      } catch (error) {
        alert("Error fetching data from Helius: " + error.message);
        return;
      }

      // Extract data
      const totalSupply = supplyData?.uiAmountString || "N/A";
      const freezeAuthority = accountInfoData?.freezeAuthority || null;
      const mintAuthority = accountInfoData?.mintAuthority || null;

      // Basic "risk" logic
      let riskLabel = "Low Risk";
      let riskClass = "risk-low";
      if (freezeAuthority || mintAuthority) {
        riskLabel = "Medium Risk";
        riskClass = "risk-medium";
      }

      // Show the analysis section
      document.getElementById("analysis").style.display = "block";
      const contentDiv = document.getElementById("analysis-content");

      contentDiv.innerHTML = `
        <div class="card">
          <h3>Token Address</h3>
          <p>${tokenAddress}</p>
        </div>
        <div class="card">
          <h3>Token Name</h3>
          <p>${tokenName ? tokenName : "Not found or not Metaplex standard"}</p>
        </div>
        <div class="card">
          <h3>Supply</h3>
          <p>${totalSupply}</p>
        </div>
        <div class="card">
          <h3>Mint Authority</h3>
          <p>${mintAuthority ? mintAuthority : "None"}</p>
        </div>
        <div class="card">
          <h3>Freeze Authority</h3>
          <p>${freezeAuthority ? freezeAuthority : "None"}</p>
        </div>
        <div class="card">
          <h3>Risk Factors</h3>
          <span class="risk-label ${riskClass}">${riskLabel}</span>
        </div>
      `;
    });
  </script>
</body>
</html>
